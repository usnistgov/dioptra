types:
  path:
  classifier:
  num_null:
    union: [number, "null"]
  path_string:
    union: [string, path]
  list_path_string:
    list: path_string
  str_null:
    union: [string, "null"]
  list_str_null:
    list: str_null
  directory_iterator:
  kwargs:
    mapping: [string, any]
  image_size:
    tuple: [integer, integer, integer]

parameters:
  run_id: ""
  image_size: [28, 28, 1]
  model_name: mnist_classifier
  model_version: -1
  job_id:
  tar_name: testing_adversarial_fgm.tar.gz
  data_dir: adv_testing
  seed: -1

tasks:
  load_artifacts_for_job:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.load_artifacts_for_job
    inputs:
      - job_id: string
      - name: files
        type: list_path_string
        required: false
      - name: extract_files
        type: list_path_string
        required: false
  load_dataset:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.load_dataset
    inputs:
      - name: ep_seed
        type: integer
        required: false
      - name: training_dir
        type: string
        required: false
      - name: testing_dir
        type: string
        required: false
      - name: subsets
        type: list_str_null
        required: false
      - name: image_size
        type: image_size
        required: false
      - name: rescale
        type: number
        required: false
      - name: validation_split
        type: num_null
        required: false
      - name: batch_size
        type: integer
        required: false
      - name: label_mode
        type: string
        required: false
      - name: shuffle
        type: boolean
        required: false
    outputs:
      - training: directory_iterator
      - validation: directory_iterator
      - testing: directory_iterator

  load_model:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.load_model
    inputs:
      - name: model_name
        type: string
        required: false
      - name: model_version
        type: integer
        required: false
      - name: imagenet_preprocessing
        type: boolean
        required: false
      - name: art
        type: boolean
        required: false
      - name: classifier_kwargs
        type: kwargs
        required: false
    outputs:
      classifier: classifier
      
  model_metrics:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.model_metrics
    inputs:
      - classifier: classifier
      - dataset: directory_iterator

graph:
  load:
    load_artifacts_for_job:
      job_id: $job_id
      extract_files: [$tar_name]

  dataset:
    load_dataset:
      ep_seed: $seed
      testing_dir: $data_dir
      subsets: [testing]
      image_size: $image_size
 
  model:
    load_model:
      model_name: $model_name
      model_version: $model_version

  metrics:
    model_metrics:
      classifier: $model
      dataset: $dataset.testing
    dependencies:
      - model