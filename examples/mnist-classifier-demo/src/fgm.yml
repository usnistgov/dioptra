types:
  path:
  classifier:
  artifact:
  model_list:
    list: classifier
  artifact_list:
    list: artifact
  path_string:
    union: [string, path]
  kwargs:
    mapping: [string, any]
  kwargs_null:
    union: [kwargs, "null"]
  distance_metric_request:
    mapping: [string, string]
  distance_metrics_requests:
    list: distance_metric_request
  image_size:
    tuple: [integer, integer, integer]
  clip_values:
    tuple: [number, number, number]
  norm:
    union: [integer, number, string]
  str_null:
    union: [string, "null"]
  list_str_null:
    list: str_null
  num_null:
    union: [number, "null"]
  directory_iterator:
  name_parameters:
    mapping:
      name: string
      parameters:
        mapping: [string, any]
  metrics_list:
    list: name_parameters

parameters:
  data_dir: /dioptra/data/Mnist/testing
  image_size: [28, 28, 1]
  adv_tar_name: testing_adversarial_fgm.tar.gz
  adv_data_dir: adv_testing
  distance_metrics_filename: distance_metrics.csv
  model_name: mnist_classifier
  model_version: -1
  clip_values: [0, 1]
  batch_size: 32
  eps: 0.3
  eps_step: 0.1
  minimal: false
  norm: "inf"
  seed: -1

tasks:
  load_dataset:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.load_dataset
    inputs:
      - name: ep_seed
        type: integer
        required: false
      - name: data_dir
        type: string
        required: false
      - name: subsets
        type: list_str_null
        required: false
      - name: image_size
        type: image_size
        required: false
      - name: rescale
        type: number
        required: false
      - name: validation_split
        type: num_null
        required: false
      - name: batch_size
        type: integer
        required: false
      - name: label_mode
        type: string
        required: false
      - name: shuffle
        type: boolean
        required: false
    outputs:
      - training: directory_iterator
      - validation: directory_iterator
      - testing: directory_iterator

  load_model:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.load_model
    inputs:
      - name: model_name
        type: string
        required: false
      - name: model_version
        type: integer
        required: false
      - name: imagenet_preprocessing
        type: boolean
        required: false
      - name: art
        type: boolean
        required: false
      - name: classifier_kwargs
        type: kwargs
        required: false
    outputs:
      classifier: classifier

  attack:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.attack
    inputs:
      - dataset: any
      - data_dir: string
      - adv_data_dir: path_string
      - classifier: any
      - image_size: image_size
      - distance_metrics: distance_metrics_requests
      - name: rescale
        type: number
        required: false
      - name: batch_size
        type: integer
        required: false
      - name: label_mode
        type: string
        required: false
      - name: eps
        type: number
        required: false
      - name: eps_step
        type: number
        required: false
      - name: minimal
        type: boolean
        required: false
      - name: norm
        type: norm
        required: false
      - name: file_format_kwargs
        type: kwargs_null
        required: false
    outputs:
      ret: artifact
  save_artifacts_and_models:
    plugin: dioptra_custom.fgm_mnist_demo.plugins.save_artifacts_and_models
    inputs:
      - name: artifacts 
        type: artifact_list
        required: false
      - name: models
        type: model_list
        required: false

graph:    
  dataset:
    load_dataset:
      ep_seed: $seed
      data_dir: $data_dir
      subsets: [testing]
      image_size: $image_size
      batch_size: $batch_size

  model:
    load_model:
      model_name: $model_name
      model_version: $model_version
      art: true
      classifier_kwargs:
        clip_values: $clip_values


  fgm:
    attack:
      dataset: $dataset.testing
      data_dir: $data_dir
      adv_data_dir: $adv_data_dir
      classifier: $model
      image_size: $image_size
      batch_size: $batch_size
      eps: $eps
      eps_step: $eps_step
      minimal: $minimal
      norm: $norm
      distance_metrics:
        - name: l_infinity_norm
          func: l_inf_norm
        - name: l_1_norm
          func: l_1_norm
        - name: l_2_norm
          func: l_2_norm
        - name: cosine_similarity
          func: paired_cosine_similarities
        - name: euclidean_distance
          func: paired_euclidean_distances
        - name: manhattan_distance
          func: paired_manhattan_distances
        - name: wasserstein_distance
          func: paired_wasserstein_distances

  save:
    save_artifacts_and_models:
      artifacts:
        - type: tarball
          adv_data_dir: $adv_data_dir
          adv_tar_name: $adv_tar_name
        - type: dataframe
          data_frame: $fgm
          file_name: $distance_metrics_filename
          file_format: csv.gz
          file_format_kwargs:
            index: false