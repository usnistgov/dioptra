# Alembic Database Migration Scripts

<!-- markdownlint-disable MD007 MD030 -->
- [Assumptions](#assumptions)
- [Generate a migration script for changes to the ORM](#generate-a-migration-script-for-changes-to-the-orm)
- [Generate an empty migration script](#generate-an-empty-migration-script)
<!-- markdownlint-enable MD007 MD030 -->

## Assumptions

The information presented in this article makes the following assumptions:

-   You've created and activated your [virtual environment](../../DEVELOPER.md#setting-up-the-python-virtual-environment).

-   The following environment variables are set in your environment:

        DIOPTRA_RESTAPI_DEV_DATABASE_URI="sqlite:////full/path/to/dioptra/dioptra-migration.db"
        DIOPTRA_RESTAPI_ENV=dev

-   The SQLite database file set in the environment variable `DIOPTRA_RESTAPI_DEV_DATABASE_URI` does not exist. If it does, it should be temporarily renamed or deleted.

-   Running `dioptra-db --help` on the commandline prints a help message listing the available commands and the environment variables that you need to set. Run `dioptra-db <COMMAND> --help` to print the help message for a specific command.

## Generate a migration script for changes to the ORM

> A migration script is only generated if there are changes to the ORM. If no changes are detected, no new migration script will be created.

To begin, scaffold a fresh database instance with all existing migration scripts applied to ensure the schema is up to date before generating a migration.

```sh
dioptra-db autoupgrade
```

This creates a database schema with all tables but without any data.

Next, generate a migration script based on changes to the ORM,

```sh
dioptra-db migrate -m "Describe the change"
```

The autogenerated migration file will appear under `src/dioptra/restapi/db/alembic/versions`. Review the generated migration script and modify the `upgrade()` and `downgrade()` functions as needed to handle existing data appropriately. This is especially important when:

-   Renaming columns or tables

-   Adding non-nullable fields to existing tables

-   Migrating existing data formats to new structures

## Generate an empty migration script

> Use an empty migration script when making database modifications that do not correspond to ORM changes, such as updating enum table values or performing other database maintenance that is not captured as changes to the ORM.

To begin, scaffold a fresh database instance with all existing migration scripts applied to ensure the schema is up to date before generating a migration.

```sh
dioptra-db autoupgrade
```

Next, create an empty migration script,

```sh
dioptra-db revision -m "Describe the change"
```

The empty migration file will appear under `src/dioptra/restapi/db/alembic/versions`. This script will contain only the basic structure needed to define a migration but will not include any autogenerated actions. Modify the `upgrade()` and `downgrade()` functions as appropriate.
