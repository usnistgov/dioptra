<template>
  <PageTitle 
    title="Entrypoints"
  />
  <TableComponent 
    :rows="entrypoints"
    :columns="showDrafts ? columns.filter((col) => col.name !== 'tags' && col.name !== 'hasDraft') : columns"
    :showExpand="true"
    title="Entrypoints"
    v-model:selected="selected"
    :pagination="{sortBy: 'draft', descending: true}"
    @edit="router.push(`/entrypoints/${selected[0].id}${draftType ? '/newDraft' : ''}`)"
    @editResourceDraft="loadResouceDraft(selected[0])"
    @delete="showDeleteDialog = true"
    @request="getEntrypoints"
    ref="tableRef"
    :showToggleDraft="true"
    v-model:showDrafts="showDrafts"
    @editTags="(row) => { editObjTags = row; showTagsDialog = true }"
    @deleteResourceDraft="resourceDraftMode = true; showDeleteDialog = true;"
  >
    <template #body-cell-group="props">
      <div>{{ props.row.group.name }}</div>
    </template>
    <template #body-cell-taskGraph="props">
      <q-btn
        v-if="props.row.taskGraph.length"
        label="View YAML"
        color="primary"
        @click.stop="displayYaml = props.row.taskGraph; showTaskGraphDialog = true;"
      />
      <span v-else class="text-negative">
        EMPTY
      </span>
    </template>
    <template #body-cell-parameterNames="props">
      <label v-for="(param, i) in props.row.parameters" :key="i">
        {{ param.name }} <br>
      </label>
    </template>
    <template #body-cell-parameterTypes="props">
      <label v-for="(param, i) in props.row.parameters" :key="i">
        {{ param.parameterType }} <br>
      </label>
    </template>
    <template #body-cell-defaultValues="props">
      <label v-for="(param, i) in props.row.parameters" :key="i">
        {{ param.defaultValue }} <br>
      </label>
    </template>
    <template #expandedSlot="{ row }">
      <CodeEditor v-model="row.taskGraph" language="yaml" :readOnly="true" />
    </template>
    <template #body-cell-plugins="props">
      <q-chip
        v-for="(plugin, i) in props.row.plugins"
        :key="i"
        color="secondary" 
        text-color="white"
      >
        {{ plugin.name }}
      </q-chip>
      <q-btn
        round
        size="sm"
        icon="add"
        @click.stop="editEntrypoint = props.row; showAssignPluginsDialog = true"
      />
    </template>
    <template #body-cell-hasDraft="props">
      <q-btn
        round
        size="sm"
        :icon="props.row.hasDraft ? 'sym_o_draft' : 'add'"
        :color="props.row.hasDraft ? 'primary' : ''"
        :text-color="props.row.hasDraft ? '' : 'black'"
        :disable="props.row.hasDraft"
        @click="() => { if(!props.row.hasDraft) loadResouceDraft(props.row) }"
      >
        <q-tooltip>
          <p v-if="props.row.hasDraft" class="q-mb-none">
            This resource has an associated draft.<br>Use table buttons to edit/delete.
          </p>
          <p v-else class="q-mb-none">
            Click here to add a draft for this resource.
          </p>
          
        </q-tooltip>
      </q-btn>
    </template>
  </TableComponent>

  <q-btn 
    class="fixedButton"
    round
    color="primary"
    icon="add"
    size="lg"
    to="/entrypoints/new"
  >
    <span class="sr-only">Register new Entrypoint</span>
    <q-tooltip>
      Register new Entrypoint
    </q-tooltip>
  </q-btn>

  <InfoPopupDialog
    v-model="showTaskGraphDialog"
  >
    <template #title>
      <label id="modalTitle">
        Task Graph YAML
      </label>
    </template>
    <CodeEditor v-model="displayYaml" language="yaml" style="height: auto;" :readOnly="true" />
  </InfoPopupDialog>
  <DeleteDialog 
    v-model:showDialog="showDeleteDialog"
    @submit="deleteEntryPoint"
    type="Entry Point"
    :name="selected.length ? selected[0].name : ''"
    v-model:resourceDraftMode="resourceDraftMode"
  />
  <AssignTagsDialog 
    v-model="showTagsDialog"
    :editObj="editObjTags"
    type="entrypoints"
    @refreshTable="tableRef.refreshTable()"
  />
  <AssignPluginsDialog 
    v-model="showAssignPluginsDialog"
    :editObj="editEntrypoint"
    @refreshTable="tableRef.refreshTable()"
  />
</template>

<script setup>
  import TableComponent from '@/components/TableComponent.vue'
  import { ref, computed } from 'vue'
  import { useRouter } from 'vue-router'
  import CodeEditor from '@/components/CodeEditor.vue'
  import InfoPopupDialog from '@/dialogs/InfoPopupDialog.vue'
  import * as api from '@/services/dataApi'
  import * as notify from '../notify'
  import DeleteDialog from '@/dialogs/DeleteDialog.vue'
  import PageTitle from '@/components/PageTitle.vue'
  import AssignTagsDialog from '@/dialogs/AssignTagsDialog.vue'
  import AssignPluginsDialog from '@/dialogs/AssignPluginsDialog.vue'

  const router = useRouter()

  const columns = [
    { name: 'name', label: 'Name', align: 'left', field: 'name', sortable: true, },
    { name: 'description', label: 'Description', align: 'left', field: 'description', sortable: true, },
    { name: 'hasDraft', label: 'hasDraft', align: 'left', field: 'hasDraft', sortable: true },
    { name: 'taskGraph', label: 'Task Graph', align: 'left', field: 'taskGraph',sortable: true, },
    { name: 'parameterNames', label: 'Parameter Name(s)', align: 'left', sortable: true },
    { name: 'parameterTypes', label: 'Parameter Type(s)', align: 'left', field: 'parameterTypes', sortable: true },
    { name: 'defaultValues', label: 'Default Values', align: 'left', field: 'defaultValues', sortable: true },
    { name: 'tags', label: 'Tags', align: 'left', field: 'tags', sortable: true },
    { name: 'plugins', label: 'Plugins', align: 'left', field: 'plugins', sortable: true },
  ]

  const selected = ref([])

  const draftType = computed(() => {
    if(selected.value.length === 0) return null
    if(Object.hasOwn(selected.value[0], 'payload') && !selected.value[0].resource) {
      return 'newDraft'
    }
  })

  const showTaskGraphDialog = ref(false)
  const displayYaml = ref('')

  const tableRef = ref(null)
  
  const entrypoints = ref([])

  const showDeleteDialog = ref(false)
  const showAssignPluginsDialog = ref(false)
  const editEntrypoint = ref('')

  async function getEntrypoints(pagination, showDrafts) {
    try {
      const res = await api.getData('entrypoints', pagination, showDrafts)
      entrypoints.value = res.data.data
      tableRef.value.updateTotalRows(res.data.totalNumResults)
    } catch(err) {
      console.log('err = ', err)
      notify.error(err.response.data.message)
    } 
  }

  async function deleteEntryPoint(resourceDraft) {
    try {
      if(resourceDraft) {
        await api.deleteResourceDraft('entrypoints', selected.value[0].id)
        notify.success(`Sucessfully deleted draft for '${selected.value[0].name}'`)
      } else if(Object.hasOwn(selected.value[0], 'payload') && !selected.value[0].resource) {
        await api.deleteDraft('entrypoints', selected.value[0].id)
        notify.success(`Sucessfully deleted '${selected.value[0].name}'`)
      } else {
        await api.deleteItem('entrypoints', selected.value[0].id)
        notify.success(`Sucessfully deleted '${selected.value[0].name}'`)
      }
      showDeleteDialog.value = false
      selected.value = []
      tableRef.value.refreshTable()
    } catch(err) {
      notify.error(err.response.data.message)
    }
  }

  const editObjTags = ref({})
  const showTagsDialog = ref(false)

  const showDrafts = ref(false)

  async function loadResouceDraft(entryPoint) {
    let res
    console.log('entrypoint = ', entryPoint)
    if(entryPoint.hasDraft) {
      try {
        res = await api.getResourceDraft('entrypoints', entryPoint.id)
        router.push(`/entrypoints/${res.data.id}/resourceDraft/${entryPoint.id}`)
      } catch(err) {
        notify.error(err.response.data.message)
      }
    } else {
      router.push(`/entrypoints/new/resourceDraft/${entryPoint.id}`)
    }
  }

  const resourceDraftMode = ref(false)
  

</script>